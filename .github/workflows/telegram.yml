name: TelegramNotifications

on:
  push:
    branches:
      - "*"

jobs:
  get_message:
    runs-on: ubuntu-latest
    outputs:
      value: ${{ steps.stringify.outputs.message }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get the message
        id: stringify
        run: |
            export date=$(date '+%d/%m/%Y %H:%M:%S')
            export reponame=${{ github.repository }}
            export who=${{ github.triggering_actor }}
            export event=$(echo ${{ github.event_name }} | tr '[:lower:]' '[:upper:]')
            export branch=${GITHUB_REF#refs/heads/}
            export commit_msg=$(git log -1 --pretty=format:'%s')
            export commit_hash=$(git log -1 --pretty=format:'%h')
            
            # Create multi-line message in a single variable
            message="ðŸ“¢ *Repository Update Alert*
            
ðŸ”¹ *Event:* $event
ðŸ”¹ *Repository:* [$reponame](https://github.com/${{ github.repository }})
ðŸ”¹ *Branch:* \`$branch\`
ðŸ”¹ *Triggered by:* @$who
ðŸ”¹ *Time:* $date
ðŸ”¹ *Commit:* \`$commit_hash\` - $commit_msg

[View Changes](https://github.com/${{ github.repository }}/commit/${{ github.sha }})"
            
            # Use printf to handle multi-line properly and escape for GitHub Output
            {
              echo "message<<EOF"
              printf "%s" "$message"
              echo ""
              echo "EOF"
            } >> "$GITHUB_OUTPUT"

  send_notification:
    needs: get_message
    runs-on: ubuntu-latest
    steps:
      - name: Send Telegram notification
        run: |
          echo "Sending message:"
          echo "${{ needs.get_message.outputs.value }}"
          
          curl -X POST \
              -H 'Content-Type: application/json' \
              -d "{\"chat_id\": \"5619096601\", \"text\": $(printf '%s' '${{ needs.get_message.outputs.value }}' | jq -R -s .), \"parse_mode\": \"Markdown\"}" \
              https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_API }}/sendMessage
